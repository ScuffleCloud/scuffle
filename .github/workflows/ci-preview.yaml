name: ci - build previews

on:
  workflow_call:
    inputs:
      pr_number:
        type: string
        required: false
      commit_sha:
        type: string
        required: true
      dashboard_build:
        type: boolean
        required: false
        default: false
      docs_build:
        type: boolean
        required: false
        default: false
      rustdoc_build:
        type: boolean
        required: false
        default: false
      deploy:
        type: boolean
        required: false
        default: false
    secrets:
      build_buddy_token:
        required: true
      vercel_token:
        required: false
      vercel_org_id:
        required: false
      vercel_project_id_dashboard:
        required: false
      vercel_project_id_docs:
        required: false
      vercel_project_id_rustdoc:
        required: false

defaults:
  run:
    shell: bash

jobs:
  dashboard:
    if: ${{ inputs.dashboard_build }}
    runs-on: ubicloud-standard-8-ubuntu-2404
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v5

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install zstd -y

      - uses: ./.github/actions/setup-bazel
        with:
          build_buddy_token: ${{ secrets.build_buddy_token }}

      - name: Build
        run: bazel build //cloud/dashboard

      - name: Compress
        run: |
          pwd=$(pwd)
          cd ./target-bazel/bin/cloud/dashboard/build
          tar -cf - * | zstd -o "$pwd/app-scuffle-cloud.tar.zst"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ci-preview-dashboard
          path: ./app-scuffle-cloud.tar.zst

      - name: Deploy
        if: ${{ inputs.deploy }}
        id: deploy
        uses: amondnet/vercel-action@888da851026e0573da056b061931bcb765a915c4
        with:
          vercel-token: ${{ secrets.vercel_token }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-comment: false
          vercel-args: "--archive=tgz"
          vercel-org-id: ${{ secrets.vercel_org_id }}
          vercel-project-id: ${{ secrets.vercel_project_id_dashboard }}
          working-directory: ./target-bazel/bin/cloud/dashboard/build

  docs:
    if: ${{ inputs.docs_build }}
    runs-on: ubicloud-standard-8-ubuntu-2404
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v5

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install zstd -y

      - uses: ./.github/actions/setup-bazel
        with:
          build_buddy_token: ${{ secrets.build_buddy_token }}

      - name: Build
        run: bazel build //cloud/docs

      - name: Compress
        run: |
          pwd=$(pwd)
          cd ./target-bazel/bin/cloud/docs/build
          tar -cf - * | zstd -o "$pwd/docs-scuffle-cloud.tar.zst"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: "ci-preview-docs"
          path: ./docs-scuffle-cloud.tar.zst

      - name: Deploy
        if: ${{ inputs.deploy }}
        id: deploy
        uses: amondnet/vercel-action@888da851026e0573da056b061931bcb765a915c4
        with:
          vercel-token: ${{ secrets.vercel_token }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-comment: false
          vercel-args: "--archive=tgz"
          vercel-org-id: ${{ secrets.vercel_org_id }}
          vercel-project-id: ${{ secrets.vercel_project_id_docs }}
          working-directory: ./target-bazel/bin/cloud/docs/build

  rustdoc:
    if: ${{ inputs.rustdoc_build }}
    runs-on: ubicloud-standard-8-ubuntu-2404
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v5

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install zstd -y

      - uses: ./.github/actions/setup-bazel
        with:
          build_buddy_token: ${{ secrets.build_buddy_token }}

      - name: Build
        run: bazel build //docs:rustdoc

      - name: Compress
        run: |
          pwd=$(pwd)
          cd ./target-bazel/bin/docs/rustdoc.rustdoc_merge
          tar -cf - * | zstd -o "$pwd/rustdoc.tar.zst"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: "ci-preview-rustdoc"
          path: ./rustdoc.tar.zst

      - name: Deploy
        if: ${{ inputs.deploy }}
        id: deploy
        uses: amondnet/vercel-action@888da851026e0573da056b061931bcb765a915c4
        with:
          vercel-token: ${{ secrets.vercel_token }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-comment: false
          vercel-args: "--archive=tgz"
          vercel-org-id: ${{ secrets.vercel_org_id }}
          vercel-project-id: ${{ secrets.vercel_project_id_rustdoc }}
          working-directory: ./target-bazel/bin/docs/rustdoc.rustdoc_merge

  report:
    needs: [dashboard, docs, rustdoc]
    runs-on: ubuntu-24.04
    if: ${{ always() && inputs.deploy && inputs.pr_number }}
    steps:
      - uses: actions/checkout@v5

      - name: Build comment body from status artifacts
        env:
          NEEDS_JSON: ${{ toJson(needs) }}
        run: python3 .github/scripts/ci-preview-report.py

      - name: Comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ inputs.pr_number }}
          file-path: body.md
          comment-tag: scuffle-preview
